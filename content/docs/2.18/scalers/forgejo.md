+++
title = "Forgejo"
availability = "v2.18+"
maintainer = "Community"
category = "CI/CD"
description = "Scale applications based on pending jobs on Forgejo repository."
go_file = "forgejo_scaler"
+++

### Trigger Specification

This specification describes the `forgejo-runner` trigger for Forgejo Actions. It scales based on the amount of jobs pending in given runner labels.

```yaml
triggers:
  - type: forgejo-runner
    metadata:
      # Required: the name of the registered runner 
      name: "forgejo-runner-ubuntu"
      # Required: the token to connect to forgejo
      token: "scoped-token-from-forgejo"
      # Required: the url of the forgejo instance 
      address: "http://host.docker.internal:3000"
      # Optional: Scope of the jobs to check, global is the default one and will get all the jobs in the instance with the defined labels
      global: "true" 
      # Optional: User to set as a scope, global should be false, if no repo is set will get all the pending jobs for the user
      owner: "cobak"
      # Optional: Repository level scope
      repo: "my-repo"
      # Required: Will get the jobs with match with this labels
      labels: "ubuntu-latest"
```

## Configuration 

### Registering runners and binding config with autoscalers

To match job endpoints with job execution, we need to pre-register a runner, save the generated JSON file as a ConfigMap, and share it with the autoscaler. review the different ways to register a runner [here](https://forgejo.org/docs/latest/admin/runner-installation/#standard-registration),  select the desired scope (user, repository or global) and create the corresponding JSON file. 

Autoscaler definition and runner registration should match to work as expected.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: runner-config
  namespace: runners
data:
  .runner: |
    {
      "WARNING": "This file is automatically generated by act-runner. Do not edit it manually unless you know what you are doing. Removing this file will cause act runner to re-register as a new runner.",
      "id": 368,
      "uuid": "ec85849d-bba3-4abc-9303-1445d06943ff",
      "name": "forgejo-runner-78pv8-jw5mm",
      "token": "xxx",
      "address": "http://host.docker.internal:3000",
      "labels": [
        "ubuntu-latest:docker://node:20-bookworm"
      ]
    }

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: runner-registration
  namespace: runners
data:
  registration.yaml: |
    runner:
      file: /config/runner.json
      capacity: 1
```

### Create a token on forgejo

The autoscaler will continuously fetch new waiting jobs from Forgejo, so it requires a properly configured token with the appropriate permissions. Navigate to **Forgejo > User settings > Applications > Access Tokens** and generate a new token. This token will be used by the autoscaler

### Configuring KEDA Autoscaler

Create a new custom resource with the required parameters and custom fields based on the scope chosen during runner registration. For example, set `global="true"` for global runners or specify `repo=xxx` and `owner=xxx` for repository level runners.

Choose the runner image you want to use (>6.1 of forgejo runner releases) or a custom one with `--one-job` command. 

Apply the new custom resource to your cluster.

```yaml
apiVersion: keda.sh/v1alpha1
kind: ScaledJob
metadata:
  labels:
    app: forgejo-runner
  name: forgejo-runner
  namespace: runners
spec:
  jobTargetRef:
    template:
      metadata:
        labels:
          app: forgejo-runner
      spec:
        volumes:
        - name: runner-data
          persistentVolumeClaim:
            claimName: runner-pvc-claim
        - name: runner-config
          configMap:
            name: runner-config
        containers:
        - name: runner
          image: code.forgejo.org/forgejo/runner:6.3.1
          command: ["sh", "-c", "forgejo-runner one-job"]
          volumeMounts:
          - name: runner-data
            mountPath: /data
          - name: runner-config
            mountPath: /config
            readOnly: false
  minReplicaCount: 0
  maxReplicaCount: 20
  pollingInterval: 30
  triggers:
  - type: forgejo-runner
    metadata:
      name: "forgejo-runner-ubuntu"
      token: "scoped-token-from-forgejo"
      address: "http://host.docker.internal:3000"
      global: "true" ## optional
      owner: "cobak" ## optional
      repo: "my-repo" ## optional
      labels: "ubuntu-latest"
```